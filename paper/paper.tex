\documentclass[10pt]{amsart}

\usepackage[allbordercolors={.192157 .76862 .28627}]{hyperref} % Emerald Green
\usepackage{amsthm, amssymb, amsaddr, fancyhdr, bookmark, fontspec, xargs, multirow, polyglossia, luacode, minted, color, soulutf8, tcolorbox, tabularx, tikz-cd, booktabs, setspace, makecell, caption, mathrsfs, xpatch, lmodern}
\usepackage[hmargin=0.4in, vmargin=0.8in, headheight=10pt]{geometry}

% Head and tail
\newcommand{\hd}{\ensuremath{\mathsf{hd}}}
\newcommand{\tl}{\ensuremath{\mathsf{tl}}}

% Universes
\newcommand{\sort}[1]{\ensuremath{\mathsf{U}_{#1}}}

% The unit type
\newcommand{\unittype}{\ensuremath{\mathsf{unit}}}
\newcommand{\unitpoint}{\ensuremath{\star}}

% Definitional and extensional equality
\newcommand{\defeq}{\ensuremath{\triangleq}}
\newcommand{\eqett}{\ensuremath{\equiv_{\mathit{ETT}}}}
\newcommand{\reflett}{\ensuremath{\mathsf{refl}_{\mathit{ETT}}}}

% Box, layer, and cube
\newcommand{\mycubset}[1]{\ensuremath{\mathsf{cubset}_{#1}}}
\newcommand{\mybox}[2]{\ensuremath{\mathsf{box}_{#1}^{#2}}}
\newcommand{\mylayer}[2]{\ensuremath{\mathsf{layer}_{#1}^{#2}}}
\newcommand{\mycube}[2]{\ensuremath{\mathsf{cube}_{#1}^{#2}}}

% Subbox, sublayer, and subcube
\newcommand{\downbox}[2]{\ensuremath{\mathsf{subbox}_{#1}^{#2}}}
\newcommand{\downlayer}[2]{\ensuremath{\mathsf{sublayer}_{#1}^{#2}}}
\newcommand{\downcube}[2]{\ensuremath{\mathsf{subcube}_{#1}^{#2}}}
\newcommand{\myfullbox}[2]{\ensuremath{\mathsf{fullbox}_{#1}^{#2}}}

% Coherence conditions
\newcommand{\cohbox}[2]{\ensuremath{\mathsf{cohbox}_{#1}^{#2}}}
\newcommand{\cohlayer}[2]{\ensuremath{\mathsf{cohlayer}_{#1}^{#2}}}
\newcommand{\cohcube}[2]{\ensuremath{\mathsf{cohcube}_{#1}^{#2}}}

% Partials and fulls related to box, cube, and tube
\newcommand{\border}[1]{\ensuremath{\mathsf{border}_{#1}}}
\newcommand{\partialcubset}[2]{\ensuremath{\mathsf{cubset}_{#1}^{<#2}}}
\newcommand{\mycubsetcomp}[2]{\ensuremath{\mathsf{cubset}_{#1}^{=#2}}}
\newcommand{\fulldownbox}[2]{\ensuremath{\mathsf{subfullbox}_{#1}^{#2}}}
\newcommand{\fulldowncube}[2]{\ensuremath{\mathsf{subfullcube}_{#1}^{#2}}}
\newcommand{\propercube}[1]{\ensuremath{\mathsf{properfiller}_{#1}}}
\newcommand{\mygroundedcube}[1]{\ensuremath{\mathsf{groundedcube}_{#1}}}
\newcommand{\tube}[1]{\ensuremath{\mathsf{tube}_{#1}}}
\newcommand{\mycubsetfrom}[2]{\ensuremath{\mathsf{cubset}_{#1}^{\geq#2}}}
\newcommand{\myfullcube}[1]{\ensuremath{\mathsf{fullcube}_{#1}}}

% Logical implication
\newcommand{\imp}{\ensuremath{\rightarrow}}
\newcommand{\overright}[1]{\ensuremath{\overrightarrow{#1}}}

% The eqntable environment, displaying the various
\NewDocumentEnvironment{eqntable}{m}{\table[!ht]
\tabularx{\textwidth}{@{} l c c >{\centering\arraybackslash}X @{}}\toprule}
{\endtabularx\hrule\caption{#1}\endtable}

% A block in the eqntable environment
\newcommand{\eqnline}[4]{$#1$ & $#2$ & $#3$ & $#4$ \\}
\newcommand{\mc}[1]{\multicolumn{4}{c}{\textit{#1}} \\\\}

% Table caption set up
\DeclareCaptionFormat{hfillstart}{\hfill#1#2#3\par}
\DeclareCaptionFont{mdit}{\mdseries\itshape}
\captionsetup[table]{
  justification=centering,
  font=bf,
  labelfont=mdit,
}

% Lettered footnotes
\renewcommand{\thefootnote}{\alph{footnote}}

% Theorems
\newtheorem{notation}{Notation}
\newtheorem{definition}{Definition}
\newtheorem{lemma}{Lemma}
\newtheorem{proposition}{Proposition}
\newtheorem{theorem}{Theorem}
\newtheorem{remark}{Remark}
\newtheorem{example}{Example}

% Simplicial sets
\newcommand{\Set}{\ensuremath{\mathsf{Set}}}
\newcommand{\op}{\ensuremath{\mathsf{op}}}
\newcommand{\Simplex}[1]{\ensuremath{\boldsymbol{\Delta^{#1}}}}
\newcommand{\DeltaHat}{\ensuremath{\hat{\boldsymbol{\Delta}}}}
\newcommand{\SSet}{\ensuremath{\mathsf{Set}_{\boldsymbol{\Delta}}}}
\newcommand{\sq}[1]{\ensuremath{\mathsf{[#1]}}}

% Cubical sets
\newcommand{\Cube}[1]{\ensuremath{\boldsymbol{\square^{#1}}}}
\newcommand{\I}[1]{\ensuremath{\mathsf{I}^{#1}}}
\newcommand{\CSet}{\ensuremath{\mathsf{Set}_{\boldsymbol{\square}}}}

% Type theory
\newcommand{\U}{\ensuremath{\mathscr{U}}}

% Roman numerals for chapters
\renewcommand{\thesection}{\Roman{section}}

% Fancy headers
\pagestyle{fancy} % choose the "fancy" pagestyle
\fancyhf{}        % clear all headers and footers
% Now set the headers
\fancyhead[LE,RO]{\footnotesize\thepage}
\fancyhead[LO,RE]{\footnotesize\leftmark}
\makeatletter
\xapptocmd{\@sect}{\csname #1mark\endcsname{#7}}{}{}
\makeatother

% Subsection centering
\makeatletter
\def\subsection{\@startsection{subsection}{2}
  \z@{.5\linespacing\@plus.7\linespacing}{.6\baselineskip}{\centering}}
\makeatother

% Nested numbering of sections and subsections
\makeatletter
\newif\ifsection
\newif\ifsubsection
\preto\section{\sectiontrue\subsectionfalse}
\preto\subsection{\sectionfalse\subsectiontrue}
\patchcmd{\@xsect}% <cmd>
  {\ignorespaces}% <search>
  {\ifsubsection
   \numberwithin{definition}{subsection}
   \else
   \numberwithin{definition}{section}
   \fi
   \setcounter{definition}{0}\relax\ignorespaces}% <replace>
  {}{}% <success><failure>
\makeatother

% Code listings
\usemintedstyle{tango}

\title{An iterated Grothendieck construction of semi-cubical types}
\author{Ramkumar Ramachandra}
\address{Université de Paris}
\author{Hugo Herbelin}
\address{Institut de Recherche en Informatique Fondamentale}

\begin{document}
\begin{abstract}
  A fresh approach to formalizing semi-cubical sets in dependent type theory with extensional equality. The approach could be described as a \emph{reverse iterated Grothendieck construction}, that is crisp and concise. The accompanying artifact is a Coq formalization that uses highly sophisticated rewriting techniques and pushes the boundary of proof assistant technology.
\end{abstract}
\maketitle
\tableofcontents
\newpage

\section{Overture}
Cubical type theory is an extension of dependent type theory that provides a computational interpretation of Voevodsky's \emph{univalence axiom}, in a field known as \emph{homotopy type theory}. Cubical type theory has several attractive features, and people have been working on it since 2014~\cite{Bezem14}. Today, an experimental branch of Agda, known as \emph{Cubical Agda} is being worked on~\cite{Vezzosi21}.

However, there is no known formalization of cubical types in \emph{Coq}, which is a vastly more powerful proof assistant than Agda. Our work lays the foundation for a future Cubical Coq.

\section{The intutution from simplicial sets}
Simplicial sets are powerful mathematical objects, that form the basis of much of modern homotopy theory. Their power derives from the fact that their homotopy category is exceptionally well-behaved, and different model structures on them, as we will see in the following chapter. Unlike CW-complexes that rely on pure topological notions like spheres and disks to ``tame'' a topological space, the definition of simplicial sets is purely categorical, and exist independent of topological spaces. The geometric realization and singular complex functors facilitate travelling back-and-forth between simplicial sets and topological spaces, and these are non-trivial constructions. As such, simplicial sets exist purely in the imagination of the mathematician; each simplicial set has an infinite number of degenerate simplices, and they are not particularly well-suited to machine-based representation.

\subsection{\texorpdfstring{\SSet}{The category of simplicial sets}}
There exists vast mathematical literature on the subject, and we refer the uninitiated reader to \cite{Friedman08} for a gentle introduction with excellent intutions. With these intuitions in place, we proceed with a purely categorical treatment. Emily Riehl's \cite{Riehl11} is a well-written manuscript on the subject.

\begin{definition}[\sq{n}]
  $\sq{n}$ is used to denote a totally-ordered set of natural numbers less than or equal to $n$, ordered by magnitude.

  \begin{equation*}
    \sq{n} := \{0, 1, \ldots, n\}
  \end{equation*}

  We will regard the totally-ordered set as a category in certain contexts, and it should be clear which interpretation we're referring to from the context.

  \begin{equation*}
    \sq{n} := 0 \rightarrow 1 \rightarrow \ldots \rightarrow n
  \end{equation*}
\end{definition}

\begin{definition}[\Simplex{}]
  The category $\Simplex{}$ is defined in terms of its objects and morphisms:

  \begin{align*}
    obj(\Simplex{}) & := \sq{n}, \text{regarded as a totally-ordered set}   \\
    mor(\Simplex{}) & := \sq{m} \rightarrow \sq{n}, \text{order-preserving}
  \end{align*}
\end{definition}

\begin{definition}[\SSet]
  The category of simplicial sets is defined as:

  \begin{equation*}
    \SSet := \Set^{\Simplex{}^\op}
  \end{equation*}

  It is a functor category, whose objects and morphisms are given by:

  \begin{align*}
    obj(\SSet)             & := \text{functors} \; \Simplex{}^\op \rightarrow \Set      \\
    mor(\SSet)             & := \text{natural transforms between the functors}          \\
    \text{composition law} & := \text{the usual composition of natural transformations} \\
  \end{align*}
\end{definition}

\begin{definition}[\Simplex{n}]
  The Yoneda embedding of $\sq{n}$ is referred to as the standard $n$-simplex.

  \begin{equation*}
    \Simplex{n} := y(\sq{n})
  \end{equation*}
\end{definition}

\begin{notation}[$\sq{0, \ldots, n}$]
  The notation $\sq{0, \ldots, n}$ denotes all ordered subsets of \sq{n}.
\end{notation}

With the definition of the category of simplicial sets firmly in place, we look inside a simplicial set to see the data it actually encodes concretely.

\begin{definition}[The data of a simplicial set]
  A simplicial set is equivalent to the data of a set of $n$-simplices, related to each other via face and degeneracy maps.

  \begin{align*}
    X_n                             & \;\;\text{a set of n-simplices} \\
    d_i : X_{n + 1} \rightarrow X_n & \;\;\text{face maps}            \\
    s_i : X_n \rightarrow X_{n + 1} & \;\;\text{degeneracy maps}      \\
  \end{align*}

  where $X_n$ is the set of $n$-simplices contained within the simplicial set $X$:

  \begin{align*}
    X_n & : \Set                                             \\
    X_n & := X(\sq{n}), \text{where X is the simplicial set} \\
  \end{align*}

  and $d_i$ and $s_i$ operate on $X_n$ as follows (the hat on $i$ indicates that it is to be omitted):

  \begin{align*}
    d_i(\sq{0, \ldots, n}) & = \sq{0, \ldots, \hat{i}, \ldots, n} \\
    s_i(\sq{0, \ldots, n}) & = \sq{0, \ldots, i, i, \ldots, n}    \\
  \end{align*}

  and $d_i$, $s_i$ are constrained by the following ``simplicial identities'':

  \begin{align*}
    d_i d_j & = d_{j - 1} d_i, i < j \\
    s_i s_j & = s_{j + 1} s_i, i < j \\
    d_i s_j & =
    \begin{cases}
      s_{j - 1} d_i & i < j \\
      id            & i = j \\
      s_j d_{i - 1} & i > j \\
    \end{cases}
  \end{align*}
\end{definition}

We mentioned degeneracies in the introduction to this section, and we define precisely what a degenerate simplex is now.

\begin{definition}[Degenerate simplex]
  A simplex is $x \in X_n$ is termed degenerate if it is the image of some degeneracy map $s_i$, and non-degenerate otherwise.
\end{definition}

\begin{example}[Non-degenerate simplices of \Simplex{n}]
  The non-degenerate $k$-simplices of $\Simplex{n}$ are the injective maps $\sq{k} \rightarrow \sq{n}$ in $\Simplex{}$. In particular, $\Simplex{n}$ has a unique non-degenerate $n$-simplex.
\end{example}

As is clear from the above definitions, simplicial sets have an infinite number of degeneracies, and the first step towards drawing a simplicial set is to define a convention that omits these degeneracies in the drawing.

\begin{notation}[Drawing of a simplicial set\label{not:drawsset}]
  A diagram of the form

  \begin{equation*}
    \begin{tikzcd}
      x \arrow[r, "f"] & y
    \end{tikzcd}
  \end{equation*}

  in simplicial set $S$ will mean that $f$ is a non-degenerate $1$-simplex, and $x$ and $y$ are $0$-simplices. The simplices have a relationship to the simplicial set $S$ given by the following commutative diagram:

  \begin{equation*}
    \begin{tikzcd}
      \Simplex{0} \arrow[dr] \arrow[drr, "x", bend left] & & \\
      & \Simplex{1} \arrow[r, "f"] & S \\
      \Simplex{0} \arrow[ur] \arrow[urr, "y"', bend right] & & \\
    \end{tikzcd}
  \end{equation*}

  To attempting to draw simplices of dimension greater than $1$, we see that there is a potential ambiguity. Consider the following diagram:

  \begin{equation*}
    \begin{tikzcd}
      & \bullet \arrow[ddr] & \\
      \\
      \bullet \arrow[uur] \arrow[rr] & & \bullet
    \end{tikzcd}
  \end{equation*}

  In the above diagram, it is clear that there are three non-degenerate $1$-simplices, but it is unclear whether there is a non-degenerate $2$-simplex. By convention, when we draw such a diagram, we will assume that there is a non-degenerate $2$-simplex border by the three non-degenerate $1$-simplices. To generalize, we will always assume that there exists a non-degenerate $n$-simplex, when bounded by non-degenerate $(n - 1)$-simplices.
\end{notation}

\begin{example}[\Simplex{0}, \Simplex{1}, and \Simplex{2}]
  $\Simplex{0}$ can be drawn as:

  $$
    \begin{tikzcd}
      0
    \end{tikzcd}
  $$

  $\Simplex{1}$ can be drawn as:

  $$
    \begin{tikzcd}
      0 \arrow[r] & 1
    \end{tikzcd}
  $$

  and $\Simplex{2}$ can be drawn as:

  $$
    \begin{tikzcd}
      & 1 \arrow[ddr] & \\
      \\
      0 \arrow[uur] \arrow[rr] & & 2
    \end{tikzcd}
  $$
\end{example}

\subsection{Motivation for \texorpdfstring{\DeltaHat}{delta sets}}
As hinted earlier, simplicial sets are ill-suited for machine-based representation, due to the infinite number of degenerate simplices that are uninteresting from the point of view of cubical type theory. To remedy this problem, let us instead use \DeltaHat, and proceed towards building, what is called \emph{semi-cubical sets} in literature. $\DeltaHat$ is identical to \Simplex{}, but for the fact that the maps $\sq{m} \rightarrow \sq{n}$ are \emph{strictly} order-preserving. The degeneracies then vanish, and we're left with the task of defining gluing conditions solely on the basis of face maps. In mathematical literature, there is little interest in studying \DeltaHat, since delta maps are not well-defined, and constructing a $\Set^{\DeltaHat^{op}}$ is inelegant.

\subsection{Towards semi-cubical sets}
We might naively attempt to define $\Cube{}$ identically to \DeltaHat, but let us briefly explain why this wouldn't work, motivating the definition of semi-cubical sets as in \cite{Antolini00}. If there were morphisms from every $\sq{m}$ to \sq{n}, we would end up with:

$$
  \begin{tikzcd}
    \bullet \arrow[r] \arrow[dr] \arrow[d] & \bullet \arrow[d] \\
    \bullet \arrow[r] \arrow[ur] & \bullet
  \end{tikzcd}
$$

where the filling conditions are conflated with the cube itself. $\Simplex{n}$ can be defined quite simply as the convex hull of $n$ points, but even defining the standard $n$-cube becomes a problem if we start with $\sq{n}$, but the situation becomes much more amenable if we define:

\begin{definition}[\Cube{n}]
  \begin{equation*}
    \Cube{n} := \I{n} = \sq{0, 1}^n
  \end{equation*}
\end{definition}

\begin{example}[$\Cube{0}$, $\Cube{1}$ and $\Cube{2}$]
  $\Cube{0}$ can be drawn as:

  $$
    \begin{tikzcd}
      0 \equiv 1
    \end{tikzcd}
  $$

  $\Cube{1}$ can be drawn as:

  $$
    \begin{tikzcd}
      0 \arrow[r, dash] & 1
    \end{tikzcd}
  $$

  and $\Cube{2}$ can be drawn as:

  $$
    \begin{tikzcd}
      (0, 1) \arrow[r, dash] & (1, 1) \arrow[d, dash] \\
      (0, 0) \arrow[u, dash] & (1, 0) \arrow[l, dash]
    \end{tikzcd}
  $$
\end{example}

Here, $\I{n}$ serves the purpose of \sq{n}, but this change will cascade into other definitions. In view of defining a category \CSet, we will restrict the morphisms in \Cube{}.

\begin{definition}[\Cube{}]
  \begin{align*}
    obj(\Cube{}) & := \I{n}                                           \\
    mor(\Cube{}) & := \delta^\epsilon_i : \I{n + 1} \rightarrow \I{n}
  \end{align*}

  where $\delta^\epsilon_i$ must satisfy the corresponding face map condition:

  \begin{equation*}
    \delta^\epsilon_i \delta^\omega_j = \delta^\omega_{j - 1} \delta^\epsilon_i
  \end{equation*}

  where $\epsilon$ and $\omega$ correspond to opposite faces.
\end{definition}

\begin{definition}[\CSet]
  Just as in \SSet, we define semi-cubical sets as the functor category:

  \begin{equation*}
    \CSet := \Set^{\Cube{}^{op}}
  \end{equation*}
\end{definition}

Or, in terms of objects and morphisms:

\begin{definition}[$\CSet$ in terms of objects and morphisms]
  \begin{align*}
    obj(\CSet) & := X_n                                                   \\
    mor(\CSet) & := X_\lambda, \text{where $\lambda$ is \Cube{}-morphism}
  \end{align*}

  where we term $X_n$ as the $n$-cubex, and $X_\lambda$ as the ``face map'', defined similarly:

  \begin{align*}
    X_n       & := X(\I{n}), \text{where X is the semi-cubical set} \\
    X_\lambda & := X(\lambda)
  \end{align*}
\end{definition}

\begin{theorem}
  $\CSet$ does not admit degeneracies.
\end{theorem}

\begin{proof}
  The reader is advised to refer to \cite{Antolini00} for the proof.
\end{proof}

\section{Grothendieck construction}
The Grothendieck construction provides a correspondence between a fibered representation, and an indexed representation.

$$
  \begin{tikzcd}
    X_0 : \U & X_1 : \U \arrow[l, "\delta^\epsilon_0" description, shift left=2] \arrow[l, "\delta^\omega_0" description, shift right=2] & X_2 : \U \arrow[l, "\delta^\epsilon_1" description, shift left=6] \arrow[l, "\delta^\epsilon_0" description, shift left=2] \arrow[l, "\delta^\omega_0" description, shift right=2] \arrow[l, "\delta^\omega_1" description, shift right=6] & \ldots
  \end{tikzcd}
$$

\begin{align*}
  X_0 & : \U                                                                                                      \\
  X_1 & : X_0 \times X_0 \rightarrow \U                                                                           \\
  X_2 & : \forall a b c d, X_1 : ab \rightarrow X_1 : bc \rightarrow X_1 : cd \rightarrow X_1 : da \rightarrow \U \\
  \ldots
\end{align*}

\section{Semi-cubical sets}
In this section, we give the core of the definition of semi-cubical
sets as the coinductive limit (see table \ref{tab:barecubicalset}) of a
construction of truncated semi-cubical sets.

\subsection{Truncated semi-cubical sets}
The definition is dispatched over tables \ref{tab:barecubicalsetstructurecore}, \ref{tab:barecubicalsetstructure}, \ref{tab:barecubicalsetfaces} and \ref{tab:barecubicalsetcoherences}. It describes the structure of the underlying higher-dimensional relations on which cubes and boxes are built, together with the definition of homogeneous $n$-boxes, homogeneous $n$-cubes, together with face operations on boxes and cubes, together with commutation properties of the face operations. All are mutually defined as types of the target language ETT. Note that such relational structure, cubes and boxes are relative to a universe. Note the presence of a coherence condition $\cohbox{l}{}$ to ensuring that both sides of the equality in $\downlayer{l}{}$ and $\downcube{l}{}$ are in the same type. The proof of $\cohbox{l}{}$ itself requires an higher-dimensional coherence condition which we obtain by working here in ETT where all proofs of an equality are identified (principle of Unicity of Identity Proofs). Note that if the proofs of the same equality were not equated, there would be a need for arbitrary many higher-dimensional coherences (see e.g.~\cite{Herbelin15} for a discussion on the de facto need for recursive higher-dimensional coherence conditions in formulating higher-dimensional structures in type theory). Note also that for a given $n$, the coherence conditions evaluate to a reflexivity proof, so that the construction evaluates to an effective sequence of types of iterated relations not mentioning $\downbox{l}{}$ nor $\cohbox{l}{}$ anymore.

When reflexivities are excepted, we call the structure thus defined \emph{bare truncated cubical sets}: \emph{bare} because it can be seen as defining semi-cubical sets corresponding to semi-simplicial sets with only faces as part of the structure; \emph{truncated} because we consider only such cubical sets up to some fixed dimension.

\begin{eqntable}{Definition of a truncated cubical set (main part of the higher-dimensional relation structure)\label{tab:barecubicalsetstructurecore}}
  \mc{Type of truncated cubical sets}
  \eqnline{\partialcubset{l}{n}}{}{:}{\sort{l+1}}
  \eqnline{\partialcubset{l}{0}}{}{\defeq}{\unittype}
  \eqnline{\partialcubset{l}{n'+1}}{}{\defeq}{\ensuremath{\Sigma}D:\partialcubset{l}{n'}.\,\mycubsetcomp{l}{n'}(D)}

  \\

  \mc{Structure carried at each dimension}
  \eqnline{\mycubsetcomp{l}{n}}{(D:\partialcubset{l}{n})}{:}{\sort{l}}
  \eqnline{\mycubsetcomp{l}{n}}{D}{\defeq}{\myfullbox{l}{n}(D)\imp \sort{l}}
\end{eqntable}

\begin{eqntable}{Definition of a truncated cubical set (boxes)\label{tab:barecubicalsetstructure}}
  \mc{Full homogeneous $n$-boxes}
  \eqnline{\myfullbox{l}{n}}{(D:\partialcubset{l}{n})}{:}{\sort{l}}
  \eqnline{\myfullbox{l}{n}}{D}{\defeq}{\mybox{l}{n,n}(D)}

  \\

  \mc{Homogeneous partial $n$-boxes and homogeneous partial $n$-cubes}
  \eqnline{\mybox{l}{n,p,[p \leq n]}}{(D:\partialcubset{l}{n})}{:}{\sort{l}}
  \eqnline{\mybox{l}{n,0}}{D}{\defeq}{\unittype}
  \eqnline{\mybox{l}{n,p'+1}}{D}{\defeq}{\Sigma d:\mybox{l}{n,p'}(D).\,\mylayer{l}{n,p'}(D)(d)}

  \\

  \eqnline{\mylayer{l}{n,p,[p < n]}}{\makecell{(D:\partialcubset{l}{n}) \\ (d:\mybox{l}{n,p}(D))}}{:}{\sort{l}}

  \eqnline{\mylayer{l}{n,p}}{D~d}{\defeq}{\makecell{\mycube{l}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,L,p}{n,p}(D)(d)) \\ \times\;\mycube{l}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,R,p}{n,p}(D)(d))}}

  \\

  \eqnline{\mycube{l}{n,p,[p \leq n]}}{\makecell{(D:\partialcubset{l}{n}) \\(E:\mycubsetcomp{l}{n}(D)) \\ (d:\mybox{l}{n,p}(D))}}{:}{\sort{l}}

  \eqnline{\mycube{l}{n,p,[p = n]}}{D~E~d}{\defeq}{E.\mathsf{rel}(d)}

  \eqnline{\mycube{l}{n,p,[p < n]}}{D~E~d}{\defeq}{\Sigma b:\mylayer{l}{n,p}(D)(d).\,\mycube{l}{n,p+1}(D)(E)(d,b)}
\end{eqntable}

\begin{eqntable}{Definition of a homogeneous bare cubical set ($q$-th projection)\label{tab:barecubicalsetfaces}}

  \eqnline{\downbox{l,\epsilon,q}{n,p,[p \leq q \leq n - 1]}}{\makecell{(D:\partialcubset{l}{n}) \\ (d:\mybox{l}{n,p}(D))}}{:}{\mybox{l}{n-1,p}(\hd(D))}

  \eqnline{\downbox{l,\epsilon,q}{n,p'+1}}{D~(d,b)}{\defeq}{(\downbox{l,\epsilon,q}{n,p'}(D)(d),\downlayer{l,\epsilon,q-1}{n,p'}(D)(d)(b))}

  \\

  \eqnline{\downlayer{l,\epsilon,q}{n,p,[p \leq q \leq n - 2]}}{\makecell{(D:\partialcubset{l}{n}) \\ (d:\mybox{l}{n,p}(D)) \\ (b:\mylayer{l}{n,p}(D)(d))}}{:}{\mylayer{l}{n-1,p}(\hd(D))(\downbox{l,\epsilon,q+1}{n,p}(D)(d))}

  \eqnline{\downlayer{l,\epsilon,q}{n,p}}{D~d~c}{\defeq}{\makecell{(\overright{\cohbox{l,\epsilon,L,q,p}{n,p}(D)(d)}(\downcube{l,\epsilon,q}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,L,p}{n,p}(D)(d))(c_L)), \\ \;\overright{\cohbox{l,\epsilon,R,q,p}{n,p}(D)(d)}(\downcube{l,\epsilon,q}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,R,p}{n,p}(D)(d))(c_R)))}}

  \\

  \eqnline{\downcube{l,\epsilon,q}{n,p,[p \leq q \leq n - 1]}}{\makecell{(D:\partialcubset{l}{n}) \\ (E:\mycubsetcomp{l}{n}(D)) \\(d:\mybox{l}{n,p}(D)) \\ (b:\mycube{l}{n,p}(D)(E)(d))}}{:}{\mycube{l}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,\epsilon,q+1}{n,p}(D)(d))}

  \eqnline{\downcube{l,\epsilon,q}{n,p,[p=q]}}{D~E~d~(b,\_)}{\defeq}{b_\epsilon}

  \eqnline{\downcube{l,\epsilon,q}{n,p,[p<q]}}{D~E~d~(b,c)}{\defeq}{(\downlayer{l,\epsilon,q}{n,p}(D)(d)(b),\downcube{l,\epsilon,q}{n,p+1}(D)(E)(d,b)(c))}
\end{eqntable}

\begin{eqntable}{Definition of a homogeneous bare cubical set (commutation of $q$-th projection and $r$-th projection)\label{tab:barecubicalsetcoherences}}

  \eqnline{\cohbox{l,\epsilon,\omega,q,r}{n,p,[p \leq r \leq q \leq n - 2]}}{\makecell{(D:\partialcubset{l}{n}) \\ (d:\mybox{l}{n,p}(D))}}{:}{\makecell{\downbox{l,\epsilon,q}{n-1,p}(\hd(D))(\downbox{l,\omega,r}{n,p}(D)(d)) \\ \eqett \downbox{l,\omega,r}{n-1,p}(\hd(D))(\downbox{l,\epsilon,q+1}{n,p}(D)(d))}}

  \eqnline{\cohbox{l,\epsilon,\omega,q,r}{n,0}}{D~\unitpoint}{\defeq}{\reflett(\unitpoint)}

  \eqnline{\cohbox{l,\epsilon,\omega,q,r}{n,p'+1}}{D~(d,b)}{\defeq}{(\cohbox{l,\epsilon,\omega,q,r}{n,p'}(D)(d),\cohlayer{l,\epsilon,\omega,q,r}{n,p'}(D)(d)(b))}

  \\

  \eqnline{\cohlayer{l,\epsilon,\omega,q,r}{n,p,[p < r \leq q \leq n - 2]}}{\makecell{(D:\partialcubset{l}{n}) \\ (d:\mybox{l}{n,p}(D)) \\(b:\mylayer{l}{n,p}(D)(d))}}{:}{\makecell{\downlayer{l,\epsilon,q}{n-1,p}(\hd(D))(\downbox{l,\omega,r}{n,p}(D)(d))(\downlayer{l,\omega,r}{n,p}(D)(d)(b)) \\ \eqett \downlayer{l,\omega,r}{n-1,p}(\hd(D))(\downbox{l,\epsilon,q+1}{n,p}(D)(d))(\downlayer{l,\epsilon,q+1}{n,p}(D)(d)(b))}}

  \eqnline{\cohlayer{l,\epsilon,\omega,q,r}{n,p}}{D~d~c}{\defeq}{\makecell{(\cohcube{l,\epsilon,\omega,q-1,r-1}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,L,p}{n,p}(D)(d))(c_L), \\ \;\cohcube{l,\epsilon,\omega,q-1,r-1}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,R,p}{n,p}(D)(d))(c_R))}}

  \\

  \eqnline{\cohcube{l,\epsilon,\omega,q,r}{n,p,[p \leq r \leq q \leq n - 2]}}{\makecell{(D:\partialcubset{l}{n}) \\ (E:\mycubsetcomp{l}{n}(D)) \\ (d:\mybox{l}{n,p}(D)) \\ (b:\mycube{l}{n,p}(D)(E)(d))}}{:}{\makecell{\downcube{l,\epsilon,q}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,\omega,r}{n,p}(D)(d))(\downcube{l,\omega,r}{n,p}(D)(E)(d)(b)) \\ \eqett \downcube{l,\omega,r}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,\epsilon,q+1}{n,p}(D)(d))(\downcube{l,\epsilon,q+1}{n,p}(D)(E)(d)(b))}}

  \eqnline{\cohcube{l,\epsilon,\omega,q,r}{n,p,[p=r]}}{D~E~d~(b,\_)}{\defeq}{\reflett(\downcube{l,\epsilon,q-1}{n-1,p}(\hd(D))(\tl(D))(\downbox{l,\omega,p}{n,p}(D)(d))(b_{\epsilon}))}

  \eqnline{\cohcube{l,\epsilon,\omega,q,r}{n,p,[p<r]}}{D~E~d~(b,c)}{\defeq}{(\cohlayer{l,\epsilon,\omega,q,r}{n,p}(D)(d)(b),\;\cohcube{l,\epsilon,\omega,q,r}{n,p+1}(D)(E)(d,b)(c))}
\end{eqntable}

\subsection{Derived notions\label{sec:derived-notions}}
On top of the basic definitions on tables \ref{tab:barecubicalsetstructure}, \ref{tab:barecubicalsetfaces} and \ref{tab:barecubicalsetcoherences}, we can define on tables \ref{tab:macros} and \ref{tab:macroscont} a few other concepts at a more standard level of abstraction. In particular, a homogeneous $n$-box in the above sense is defined to be an object of type $\myfullbox{l}{n}(D_{n})$ for $D_{n} \defeq (A, =_A, \ldots, =^n_A)$ the initial segment of $n$-th first iterated equalities over $A$ (by convention, a homogeneous $0$-box shall be the canonical singleton type). A $n$-tube is of type $\mybox{l}{n+1,n}(D_{n+1})$. An homogeneous (proper) $n$-cube in some $n$-box $d$ is of type $\mycube{l}{n+1,n}(\hd(D_{n+1}))(\tl(D_{n+1}))(d)$ and a full $n$-cube is of type $\mycube{l}{n+1,0}(\hd(D_{n+1}))(\tl(D_{n+1})))(\star)$.

Note that the components of an $n$-box or $n$-tube are tuples associated to the left. For cubes, the components can be associated to the left, and we call this a full $n$-cube or to the right, which we call grounded $n$-cube, and which corresponds to ``complete'' partial cubes, i.e. to partial cubes over the empty box. Table \ref{tab:macros} show how to compute the $n$-box surrounding a full $n$-cube over a prefix $D_{n+1}$ of iterated equalities (see $\border{}$).

Table \ref{tab:macros} also shows how to compute the faces of a box or of a cube.

\begin{eqntable}{Definition of a bare cubical set (coinductive structure)\label{tab:barecubicalset}}
  \mc{Full (non-truncated) cubical sets with degeneracies}
  \eqnline{\mycubset{l}}{}{:}{\sort{l+1}}
  \eqnline{\mycubset{l}}{}{\defeq}{\mycubsetfrom{l}{0}(\star)}
  \\
  \eqnline{\mycubsetfrom{l}{n}}{(D:\partialcubset{l}{n})}{:}{\sort{l+1}}
  \eqnline{\mycubsetfrom{l}{n}}{D}{\defeq}{\Sigma R:\mycubsetcomp{l}{n}(D).\,\mycubsetfrom{l}{n+1}(D,R)}
\end{eqntable}

\begin{eqntable}{Standard derived notions\label{tab:macros}}
  \mc{Type of full $n$-cubes}
  \eqnline{\myfullcube{l}^{n}}{(D:\partialcubset{l}{n+1})}{:}{\sort{l}}

  \eqnline{\myfullcube{l}^{n}}{(D,E)}{\defeq}{\Sigma d:\myfullbox{l}{n}(D).\, E.\mathsf{rel}(d)}

  \\ \mc{Type of $n$-tubes}

  \eqnline{\tube{l}^{n}}{(D:\partialcubset{l}{n+1})}{:}{\sort{l}}
  \eqnline{\tube{l}^{n}}{D}{\defeq}{\mybox{l}{n+1,n}(D)}

  \\ \mc{Type of grounded $n$-cubes}

  \eqnline{\mygroundedcube{l}^{n}}{(D:\partialcubset{l}{n+1})}{:}{\sort{l}}
  \eqnline{\mygroundedcube{l}^{n}}{(D,E)}{\defeq}{\mycube{l}{n,0}(D)(E)(\star)}

  \\ \mc{Type of fillers of some $n$-box}

  \eqnline{\propercube{l}^{n}}{(D:\partialcubset{l}{n+1})~(d:\myfullbox{l}{n}(\hd(D)))}{:}{\sort{l}}

  \eqnline{\propercube{l}^{n}}{(D,E)~d}{\defeq}{E.\mathsf{rel}(d)}

  \\ \mc{Border of a grounded $n$-cube}

  \eqnline{\border{l}^{n}}{(D:\partialcubset{l}{n+1})~(c:\mygroundedcube{l}^{n}(D))}{:}{\myfullbox{l}{n}(\hd(D))}

  \eqnline{\border{l}^{n}}{D~c}{\defeq}{\border{l}^{n,0}(D)(\star)(c)}

  \\ \mc{where the border of partial cubes is defined by}

  \eqnline{\border{l}^{n,p}}{(D:\partialcubset{l}{n+1})~(d:\mybox{l}{n,p}(\hd(D)))~(c:\mycube{l}{n,p}(\hd(D))(\tl(D))(d))}{:}{\myfullbox{l}{n}(\hd(D))}

  \eqnline{\border{l}^{n,p,[p=n]}}{D~d~c}{\defeq}{d}

  \eqnline{\border{l}^{n,p,[p<n]}}{D~d~(b,c)}{\defeq}{\border{l}^{n,p+1}(D)(d,b)(c)}
\end{eqntable}

\begin{eqntable}{Standard derived notions (continued)\label{tab:macroscont}}
  \mc{$q$-th projection of an $n$-box}

  \eqnline{\fulldownbox{l,\epsilon,q}{n,[q < n]}}{(D:\partialcubset{l}{n})~(d:\myfullbox{l}{n}(D))}{:}{\myfullbox{l}{n-1}(\hd(D))}

  \eqnline{\fulldownbox{l,\epsilon,q}{n}}{D~(d,\_)}{\defeq}{\downbox{l,\epsilon,q}{n,n-1}(D)(d)}

  \\ \mc{$q$-th face of an $n$-cube}

  \eqnline{\fulldowncube{l,\epsilon,q}{n,[q < n]}}{(D:\partialcubset{l}{n+1})~(c:\myfullcube{l}^{n}(D))}{:}{\myfullcube{l}^{n-1}(\hd(D))}

  \eqnline{\fulldowncube{l,\epsilon,q}{n}}{(D,E)~c}{\defeq}{\downcube{l,\epsilon,q}{n,0}(D)(E)(\star)(c)}

  \\ \mc{where the extension of $\downbox{l}{}$ to $p>q$ is}

  \eqnline{\downbox{l,\epsilon,q}{n,p,[q < p < n]}}{(D:\partialcubset{l}{n})~(d:\mybox{l}{n,p}(D))}{:}{\myfullbox{l}{n-1}(\hd(D))}

  \eqnline{\downbox{l,\epsilon,q}{n,q+1}}{D~(d,b)}{\defeq}{\border{l}^{n-1,q}(\hd(D))(\downbox{l,\epsilon,q}{n,q}(D)(d))(b_{\epsilon})}

  \eqnline{\downbox{l,\epsilon,q}{n,p,[q < p-1]}}{D~(d,b)}{\defeq}{\downbox{l,\epsilon,q}{n,p-1}(D)(d)}
\end{eqntable}

\section{The formalization effort}
\subsection{Converging on an approach}
The core of our formalization effort demands proof irrelevance for inequalities. There were two approaches on the outset: one was HoTT, where we'd have proof relevance, but be able to transport one proof to another, and another was SProp, where we'd get proof irrelevance out-of-the-box. We initially experimented with HoTT, but there were serious limitations: HoTT drops the Coq standard library, and several tactics are (unfortunately) reliant on the standard library. As a result, several sophisticated tactics are infeasible in HoTT.

SProp comes with a host of bugs and it took us some time to become comfortable with it, and realize its limitations. We did go back and forth with SProp a bit, but ended up using it in the final version.


\subsection{Yoneda.v}
\subsection{RewLemmas.v}
\subsection{Notes on SProp}
\subsection{Cubical.v}

We'd tried to build the \texttt{Cubical} as a \texttt{Fixpoint} initially, but ran into unification problems with \texttt{le\_dec}.

Type unification on the term \texttt{D} fails.

\begin{minted}{coq}
From Coq Require Import Arith.

Theorem le_S_up {n m} (Hnm : n <= m) : n <= S m.
Admitted.
Theorem le_S_down {n m} (Hnm : S n <= m) : n <= m.
Admitted.
Theorem le_discr {n} : S n <= 0 -> forall {A}, A.
Admitted.
Theorem propagate_eq {m n} : m <= S n -> m = S n -> n <= n.
Admitted.
Theorem le_dec {n m} : n <= S m -> {n = S m} + {n <= m}.
Admitted.
Theorem le_dec' {n m} : n <= m -> {n = m} + {n <= pred m} + {m = O}.
Admitted.
Theorem lower_both {m n} : S m <= S n -> m <= n.
Admitted.

Notation "⇓ p" := (le_S_down p) (at level 40).
Notation "↑ h" := (le_S_up h) (at level 40).
Notation "l '.1'" := (projT1 l) (at level 40).
Notation "l '.2'" := (projT2 l) (at level 40).

Section Cubical.

Universe l'.
Universe l.

Record Cubical {n : nat} :=
{
csp {n'} (Hn' : n' <= n) : Type@{l'} ;
hd {n'} {Hn' : S n' <= n} : csp Hn' -> csp (⇓ Hn') ;
box {n' p} {Hn' : n' <= n} (Hp : p <= n') : csp Hn' -> Type@{l} ;
}.

Fixpoint cubical {n : nat} : Cubical :=
match n with
| O => {| csp _ _ := unit;
hd _ Hn' _ := ltac:(apply (le_discr Hn'));
box _ _ _ _ _ := unit;
|}
| S n => let cn := cubical (n := n) in
let cspn {n'} (Hn' : n' <= S n) :=
match le_dec Hn' with
| left Heq (* n' = S n *) => { D : cn.(csp) (propagate_eq Hn' Heq) &
cn.(box) _ D -> Type@{l} }
| right Hineq (* n' <= n *) => cn.(csp) Hineq
end in
let hdn {n'} (Hn' : S n' <= S n) :=
match le_dec' (lower_both Hn') return cspn Hn' (* S n' <= S n *) ->
cspn (⇓ Hn') (* n' <= S n *) with
| inleft Hcmp =>
match Hcmp with
| left _ (* n' = n *) => fun D => D.1 (* n' = S n *)
| right _ (* n' <= pred n *) => fun D => cn.(hd) D (* n' <= n *)
end
| inright _ (* n = O *) => fun D => cn.(hd) D
end in
  {|
    csp _ Hn' := cspn Hn';
    hd _ Hn' := hdn Hn';
    |}
end.

End Section.
\end{minted}

\begin{thebibliography}{10}
  \bibitem[Bez]{Bezem14}
  Bezem, M., Coquand, T., \& Huber, S. (2014, July). A model of type theory in cubical sets. \textit{In 19th International Conference on Types for Proofs and Programs (TYPES 2013)} (Vol. 26, pp. 107-128). Wadern, Germany: Schloss Dagstuhl–Leibniz Zentrum fuer Informatik.

  \bibitem[CubAgda]{Vezzosi21}
  Vezzosi, A., Mörtberg, A., \& Abel, A. (2021). Cubical Agda: a dependently typed programming language with univalence and higher inductive types. \textit{Journal of Functional Programming, 31}.

  \bibitem[Fri]{Friedman08}
  Friedman, G. (2008). An elementary illustrated introduction to simplicial sets. \textit{arXiv preprint arXiv:0809.4221}.

  \bibitem[Rie]{Riehl11}
  Riehl, E. (2011). A leisurely introduction to simplicial sets. \textit{Unpublished expository article available online from the author's web page}.

  \bibitem[CubSet]{Antolini00}
  Antolini, R. (2000). Cubical structures, homotopy theory. \textit{Annali di Matematica pura ed applicata, 178}(1), 317-324.

  \bibitem[Her]{Herbelin15}
  Herbelin, H. (2015). A dependently-typed construction of semi-simplicial types. \textit{Mathematical Structures in Computer Science, 25}(5), 1116-1131.
\end{thebibliography}

\appendix
\section{Source code listing}

\end{document}
